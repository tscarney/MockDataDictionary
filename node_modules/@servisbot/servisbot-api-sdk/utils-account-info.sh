#!/usr/bin/env bash
set -e

if [[ ${DEBUG} == "True" ]]; then
  set -x
fi

HELOWER=232528549124
HEUPPER=550094171826
DEVELOPMENT=616711624162
HEDEMO=246808614472
CICD=079582582350
QNB=134287087093

export AWS_ACCOUNT_ID=$(aws sts get-caller-identity --output text --query 'Account')
GIT_COMMIT_ID=$(git rev-parse --short HEAD)

if [[ ${AWS_ACCOUNT_ID} == ${HELOWER} ]]; then
    export AWS_ENV=helower
    export AWS_LOWER=helower
    export LOWER_NAME=helower
    export SLACK_CHANNEL=stagingreleases
    if [[ ${FUNCTION_VERSION} == " " || -z ${FUNCTION_VERSION} ]]; then
        export FUNC_VER=${GIT_COMMIT_ID}
        export CF_VERSION=latest
    else
        export FUNC_VER=${FUNCTION_VERSION}
        export CF_VERSION=${FUNCTION_VERSION}
    fi

elif [[ ${AWS_ACCOUNT_ID} == ${HEUPPER} ]]; then
    export AWS_ENV=heupper
    export AWS_LOWER=helower
    export LOWER_NAME=helower
    export LOWER_ACC_NO=${HELOWER}
    export SLACK_CHANNEL=releases
    if [[ ${FUNCTION_VERSION} == " " || -z ${FUNCTION_VERSION} ]]; then
        echo "ERROR: FUNCTION_VERSION empty, exiting ..."
        exit 1
    else
        export FUNC_VER=${FUNCTION_VERSION}
        export CF_VERSION=${FUNCTION_VERSION}
    fi

elif [[ ${AWS_ACCOUNT_ID} == ${QNB} ]]; then
    export AWS_ENV=qnbupper
    export AWS_LOWER=helower
    export LOWER_NAME=helower
    export LOWER_ACC_NO=${HELOWER}
    export SLACK_CHANNEL=releases
    if [[ ${FUNCTION_VERSION} == " " || -z ${FUNCTION_VERSION} ]]; then
        echo "ERROR: FUNCTION_VERSION empty, exiting ..."
        exit 1
    else
        export FUNC_VER=${FUNCTION_VERSION}
        export CF_VERSION=${FUNCTION_VERSION}
    fi

elif [[ ${AWS_ACCOUNT_ID} == ${HEDEMO} ]]; then
    export AWS_ENV=hedemo
    export AWS_LOWER=helower
    export LOWER_NAME=helower
    export LOWER_ACC_NO=${HELOWER}
    export SLACK_CHANNEL=stagingreleases
    if [[ ${FUNCTION_VERSION} == " " || -z ${FUNCTION_VERSION} ]]; then
        echo "ERROR: FUNCTION_VERSION empty, exiting ..."
        exit 1
    else
        export FUNC_VER=${FUNCTION_VERSION}
        export CF_VERSION=${FUNCTION_VERSION}
    fi

elif [[ ${AWS_ACCOUNT_ID} == ${DEVELOPMENT} ]]; then
    export AWS_ENV=hedev
    export AWS_LOWER=helower
    export LOWER_NAME=helower
    export LOWER_ACC_NO=${HELOWER}
    export SLACK_CHANNEL=
    if [[ ${FUNCTION_VERSION} == " " || -z ${FUNCTION_VERSION} ]]; then
        export FUNC_VER=${GIT_COMMIT_ID}
        export CF_VERSION=latest
    else
        export FUNC_VER=${FUNCTION_VERSION}
        export CF_VERSION=${FUNCTION_VERSION}
    fi

elif [[ ${AWS_ACCOUNT_ID} == ${CICD} ]]; then
    export AWS_ENV=cicd
else
    echo "ERROR: No account found"
fi
