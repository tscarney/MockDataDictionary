#!/usr/bin/env bash
set -e

if [[ ${DEBUG} == "True" ]]; then
  set -x
fi

function post_to_slack () {
  echo "INFO: Sending Slack message"
  jira_ticket=$(git log --format=%s -n1 | grep -o -iE "[A-Z]{3,5}-[0-9]{1,5}" | sort | uniq | tr '\n' ' ' | tr '[:lower:]' '[:upper:]')

  slack_url=$(aws ssm get-parameters --with-decryption --names /slack/notifications/${SLACK_CHANNEL} --query 'Parameters[0].Value' --output text)
  slack_message="Deployed to ${AWS_ENV} (${FUNC_VER})\n\n_Whatâ€™s in this deploy:_ ${jira_ticket}"

  curl -X POST --data "payload={\"text\": \"${slack_message}\", \"username\": \"${FUNCTION_NAME}\", \"icon_emoji\": \":botty:\"}" ${slack_url}
}

function get_version_diff() {
  echo "INFO: Getting version differences"
}